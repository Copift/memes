<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/new_post.css" rel="stylesheet" type="text/css" />
    <title>Document</title>
</head>
<body>
    <header>Не-спица
        <img src="../img/spitsi.png" />
    </header>
    <body>
        <div class="left-column">
            <div class = "personal">User-1
                <img src="../img/icon.svg">
            </div>
            <a href="./blog.html"> <div class = "black">Мой блог</div></a>
            <div>Комментарии</div>
            <div class = "black">Добавить фандом</div>
            <div>Подписки</div>
            <div class = "black">Сохраненное</div>
            <div>Частые вопросы</div>
            <div class = "black">Обучение</div>
        </div>
        <div class="center-column">
            <form action="" method="post">
                <table align="center">
                  <tr>
                    <td>
                      <fieldset>
                        <legend align="right"><label for="comment">Подпись</label></legend>
                        <input
                          id="comment"
                          name="comment"
                          type="text"
                          class="text"
                          required
                          size="27"
                        />
                      </fieldset>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <fieldset>
                        <legend align="right"><label for="image">Добавьте картинку</label></legend>
                        <div> <img id = "postImage"> </div>
                        <input
                          id="image"
                          name="f"
                          type="file"
                          required
                          size="27"
                          onChange= resetImg(this)
                        />
                      </fieldset>
                    </td>
                  </tr>
                </table>
              </form>
              <button onclick="sendChangedPost()" class="return">Заменить</button>
        </div>
    </body>
    <footer>
        <div>Политика конфиденциальности</div>
        <div>Пользовательское соглашение</div>
        <div>CC-BY</div>
    </footer>
</body>
    <script>
        // ip сервера
        const ip = '10.8.0.2:5000';

        // персональный id сессии
        var uuid = localStorage.getItem('UUID');

        // id поста который ма будем редактировать
        var  changePost_id = localStorage.getItem('changePost_id');

        // переключатель, для ограничения нажатия на кнопку
        var toggle = true;

        // старт скрипта после загрузке окна
        window.onload=startPostChange;

        // функция запускающаяся после загрузки окна
        function startPostChange(){
            // проверякм у пользователя наличее uuid
            if (!uuid){
                // если у пользователя нет uuid пересылаем его к авторизации
                window.location.replace("avt.html");
            }
            if (!changePost_id){
                // если у пользователя нет changePost_id пересылаем его к блогу
                window.location.replace("blog.html");
            }


            // Загружаем данные старого поста
            // создаём запрос
            let url = 'http://' + ip + '/post/' + changePost_id + '?uuid=' + uuid;

            // принимаем и обрабатываем данные запроса
            fetch(url)
              .then(response => response.json())    // преобразовавем запрос в json
              .then(commits => addInfo(commits));  // передаем json в функцию создания поста
        }

        // добавить данные поста в редактор
        function addInfo(commits){
            //console.log(commits);
            document.getElementById("comment").setAttribute("value", commits.text);
            document.getElementById("postImage").setAttribute("src", commits.image_link);
        }


        // фунция отправки изменённого поста в базу данных
        async function sendChangedPost(){
            // проверяем переключатель
            if (toggle){
                console.log("отправка запроса");

                // отключаем возможность отылать пост
                toggle = false;

                // берём в input содержащий текст
                let inputText = document.querySelector('input[type="text"]');
                // берём в input содержащий файл
                let inputFile = document.querySelector('input[type="file"]');

                let text = inputText.value;
                let file = inputFile.files[0];


                const data = new FormData();
                data.append("uuid", uuid);
                data.append("post_id", changePost_id);
                if (text){
                    data.append("text", text);
                }
                if (file){
                    data.append("files", file);
                }


                // оптправляем запрос
                let response = await fetch('http://' + ip + '/editPost', {
                  method: 'POST',
                  body: data
                })

                // если прищёл правильный ответ
                if (response.ok){
                    toggle = true;
                    console.log("пост создан");
                }else{
                    toggle = true;
                    console.log("ошибка в создании поста");

                    // преобразовываем запрос в json
                    let commits = await response.json();

                    // выводим сообщение об ошибке
                    console.log("error " + commits.err_code + "\n" + commits.err);
                }

            }else{
                alert("подождите, предидущий запрос ещё не отправился");
            }
        }


        // отображение картинки при её загрузке
        function  resetImg(elem){
            if (elem.files && elem.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                  document.getElementById('postImage').setAttribute('src', e.target.result);
                };

                reader.readAsDataURL(elem.files[0]);
          }
        }

    </script>

</html>
