<!DOCTYPE html>
<html lang="ru">
<link href="../css/project1.css" rel="stylesheet" type="text/css" />
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Не-спица</title>
</head>
<header>Не-спица
    <img src="../img/spitsi.png" />
</header>
<body>
    <div class="left-column">
        <div class = "personal">User-1
            <img src="../img/icon.svg">
        </div>
        <a href="./blog.html"> <div class = "black">Мой блог</div></a>
        <div>Комментарии</div>
        <div class = "black">Подписки</div>
        <div>Сохраненное</div>
        <div class = "black">Частые вопросы</div>
    </div>

    <!-- Часть, куда будут добавляться посты -->
    <div class="center-column">
        <span id="posts_line">


        </span>

    </div>


    <div class="right-column">
        <!-- кнопка добавления постов-->
        <div class="button_container">
            <button onclick="takePosts()"> Ищем! </button>
        </div>
        <img class = "one" src="../img/vereteno.svg">
        <img class = "wheel" src="../img/wheel.svg">
            <select>
                <option>#ФБКИ</option>
                <option>#Программирование</option>
                <option>#Лебедев</option>
                <option>#Петрушин</option>
              </select>

        <button class = "new" onclick="document.location='./new_post.html'">Новый пост</button>
    </div>
</body>
<footer>
    <img src = "../img/bottom.svg">
    <div>Политика конфиденциальности</div>
    <div>Пользовательское соглашение</div>
    <div>CC-BY</div>
</footer>

    <script>
        // ip сервера
        const ip = '10.8.0.1:5000';

        // персональный id сессии
        //var uuid = localStorage.getItem('UUID');
        var uuid = '0ee09b12-af98-49ad-a3dc-9b8cbc186ad5';  // ДОЛЖЕН ПОЛУЧАТЬСЯ ПРИ АВТОРИЗАЦИИ

        // количество постов в ленте
        var PostCount = 0;

        // сколько постов загружается за раз
        var step = 10;

        // старт скрипта после загрузке окна
        window.onload=startPostsLine;


        // функция запускающаяся после загрузки окна
        function startPostsLine(){
            // получаем посты из БД и добавляем их в ленту
            takePosts();
        }


        // отправляет запрос в БД и принимает его
        function takePosts(count = step){
            // создаём запрос
            let url = 'http://' + ip + '/getPostsGroup?uuid=' + uuid + '&post_id=' + PostCount + '&count=' + count;

            // принимаем и обрабатываем данные запроса
            fetch(url)
              .then(response => response.json())    // преобразовавем запрос в json
              .then(commits => addPosts(commits));  // передаем json в функцию создания поста

        }

        // добавляем посты в ленту
        function addPosts(commits, lastPost = 0){

            // проверка на превышение кол-ва постов (СДЕЛАТЬ АДАПТИВНОЙ)
            if (lastPost < commits.posts.length){
                let line = document.getElementById("posts_line");

                //console.log(commits);

                // добавляем пост в html
                line.insertAdjacentHTML('beforeend',
                                '<div>'+
                                '<div class = "img" id = "' + (PostCount + lastPost) +'_img"></div>' +
                                '<p>' + commits.posts[lastPost].post.Text + '</p>' +
                                '<div class = "reaction" >' +
                                '<p id="' + commits.posts[lastPost].post.id + '_like" >' +
                                commits.posts[lastPost].post.likes + '</p>' +
                                '<input onclick="useLike(this)" name="scattering" ' +
                                'value="' + commits.posts[lastPost].post.id + '" ' +
                                'id="' + (PostCount + lastPost) + '" ' +
                                'type="checkbox" ' + checkLike(commits.posts[lastPost].post.is_liked) + ' />' +
                                '<label for="' + (PostCount + lastPost) + '" ' +
                                'class="label_scattering"></label>'+
                                '</div>' +
                                '</div>'
                               );

                // создаем пустую картинку
                var img = new Image();

                // МЕДЛЕННЫЙ И КРАСИВЫЙ СПОСОБ СОЗДАТЬ ЛЕНТУ
                // когда картинка загружена, начинаем загрузку другой
                //img.onload = function(){
                //    addPosts(commits, lastPost+1);
                //};

                // добавляем картинке ссылку на изображение
                img.src = '' + commits.posts[lastPost].post.image_link + '';

                // здесь добавляем готовую картинку в html
                document.getElementById((PostCount + lastPost) +'_img').appendChild(img);


                // БЫСТРЫЙ НО НЕ КРАСИВЫЙ СПОСОБ СОЗДАТЬ ЛЕНТУ
                addPosts(commits, lastPost+1);


                // запоминаем id последнего поста в ленте
                if (lastPost + 1 == commits.posts.length){
                    PostCount += step;
                }
            }
        }


        // проверяем стоит ли лайк у данного поста
        function checkLike(isLiked){
            if (isLiked){
                return 'checked';
            }else{
                return '';
            }
        }


        // отправка запроса при нажатии лайка
        function useLike(elem){
            //console.log(elem.checked);
            if (elem.checked){
                // если поставили лайк
                let url = 'http://' + ip + '/setLike?uuid=' + uuid + '&post_id=' + elem.value;
                fetch(url)
                    .then(changLikeValue(elem.value, 1));
            }else{
                // если убрали лайк
                let url = 'http://' + ip + '/downLike?uuid=' + uuid + '&post_id=' + elem.value;
                fetch(url)
                    .then(changLikeValue(elem.value, -1));
            }
        }

        //id="' + commits.posts[lastPost].post.id + '_like"

        function changLikeValue(post_id, x){
            let like = document.getElementById('' + post_id + '_like');
            let val = Number(like.innerText) + x;
            like.innerText = val;
        }

    </script>

</html>
