<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/new_post.css" rel="stylesheet" type="text/css" />
    <title>Document</title>
</head>
<body>
    <header>Не-спица
        <img src="../img/spitsi.png" />
    </header>
    <body>
        <div class="left-column">
            <div class = "personal">User-1
                <img src="../img/icon.svg">
            </div>
            <a href="./blog.html"> <div class = "black">Мой блог</div></a>
            <div>Комментарии</div>
            <div class = "black">Добавить фандом</div>
            <div>Подписки</div>
            <div class = "black">Сохраненное</div>
            <div>Частые вопросы</div>
            <div class = "black">Обучение</div>
        </div>
        <div class="center-column">
            <form action="" method="post">
                <table align="center">
                  <tr>
                    <td>
                      <fieldset>
                        <legend align="right"><label for="comment">Подпись</label></legend>
                        <input
                          id="comment"
                          name="comment"
                          type="text"
                          class="text"
                          required
                          size="27"
                        />
                      </fieldset>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <fieldset>
                        <legend align="right"><label for="image">Добавьте картинку</label></legend>
                        <div> <img id = "postImage" src = "../img/spitsi.png"> </div>
                        <input
                          id="image"
                          name="f"
                          type="file"
                          required
                          size="27"
                          onChange= resetImg(this)
                        />
                      </fieldset>
                    </td>
                  </tr>
                </table>
              </form>
              <button onclick="sendPost()" class="return">Опубликовать</button>
        </div>
    </body>
    <footer>
        <div>Политика конфиденциальности</div>
        <div>Пользовательское соглашение</div>
        <div>CC-BY</div>
    </footer>
</body>
    <script>
        // ip сервера
        const ip = '10.8.0.1:5000';

        // персональный id сессии
        var uuid = localStorage.getItem('UUID');
        //var uuid = '0ee09b12-af98-49ad-a3dc-9b8cbc186ad5';  // ДОЛЖЕН ПОЛУЧАТЬСЯ ПРИ АВТОРИЗАЦИИ

        // переключатель, для ограничения нажатия на кнопку
        var toggle = true;

        // функция запускающаяся после загрузки окна
        function startPostsLine(){
            // проверякм у пользователя наличее uuid
            if (!uuid){
                //  если у пользователя нет uuid пересылаем его к авторизации
                window.location.replace("avt.html");
            }
        }


        // фунция отправки поста в базу данных
        async function sendPost(){
            // проверяем переключатель
            if (toggle){
                console.log("отправка запроса");

                // отключаем возможность отылать пост
                toggle = false;

                // берём inpyt содержащий текст
                var inputText = document.querySelector('input[type="text"]');
                // берём inpyt содержащий файл
                var inputFile = document.querySelector('input[type="file"]');

                var text = inputText.value;
                var file = inputFile.files[0];


                const data = new FormData();
                data.append("uuid", uuid);
                data.append("text", text);
                data.append("files", file);

                // оптправляем запрос
                let response = await fetch('http://' + ip + '/uploadPost', {
                  method: 'POST',
                  body: data
                })

                // если прищёл правильный ответ
                if (response.ok){
                    toggle = true;
                    console.log("пост создан");
                }else{
                    toggle = true;
                    console.log("ошибка в создании поста");
                }

            }else{
                alert("подождите, предидущий запрос ещё не отправился");
            }
        }


        // отображение картинки при её загрузке
        function  resetImg(elem){
            if (elem.files && elem.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                  document.getElementById('postImage').setAttribute('src', e.target.result);
                };

                reader.readAsDataURL(elem.files[0]);
          }
        }

    </script>

</html>
